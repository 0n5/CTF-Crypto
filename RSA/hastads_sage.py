
# This file was *autogenerated* from the file hastads.sage
from sage.all_cmdline import *   # import sage library

_sage_const_3 = Integer(3); _sage_const_1 = Integer(1); _sage_const_0 = Integer(0)
def hastads(cArray,nArray,e=_sage_const_3 ):
    """
    Performs Hastads attack on raw RSA with no padding.
    cArray = Ciphertext Array
    nArray = Modulus Array
    e = public exponent
    """

    if(len(cArray)==len(nArray)==e):
        for i in range(e):
            cArray[i] = Integer(cArray[i])
            nArray[i] = Integer(nArray[i])
        M = crt(cArray,nArray)
        return(Integer(M).nth_root(e,truncate_mode=_sage_const_1 ))
    else:
        print("CiphertextArray, ModulusArray, need to be of the same length, and the same size as the public exponent")


def linearPaddingHastads(cArray,nArray,aArray,bArray,e=_sage_const_3 ):
    """
    Performs Hastads attack on raw RSA with no padding.
    This is for RSA encryptions of the form: cArray[i] = pow(aArray[i]*msg + bArray[i],e,nArray[i])
    Where they are all encryptions of the same message.
    cArray = Ciphertext Array
    nArray = Modulus Array
    aArray = Array of 'slopes' for the linear padding
    bArray = Array of 'y-intercepts' for the linear padding
    e = public exponent
    CURRENTLY UNTESTED
    """
    if(len(cArray) == len(nArray) == len(aArray) == len(bArray) == e):
        for i in range(e):
            cArray[i] = Integer(cArray[i])
            nArray[i] = Integer(nArray[i])
            aArray[i] = Integer(aArray[i])
            bArray[i] = Integer(bArray[i])
        TArray = [-_sage_const_1 ]*e
        for i in range(e):
            arrayToCRT = [-_sage_const_1 ]*e
            for j in range(e):
                if(j==i):
                    arrayToCRT[j] = _sage_const_1
                else:
                    arrayToCRT[j] = _sage_const_0
            TArray[i] = crt(arrayToCRT,nArray)
        print(prod(nArray))
        P = PolynomialRing(Zmod(prod(nArray)), names=('x',)); (x,) = P._first_ngens(1)
        gArray = [-_sage_const_1 ]*e
        for i in range(e):
            gArray[i] = TArray[i]*pow(aArray[i]*x + bArray[i],e)
        g = sum(gArray)
        g.monic()
        # Use Sage's inbuilt coppersmith method
        return g.small_roots()

    else:
        print("CiphertextArray, ModulusArray, and the linear padding arrays need to be of the same length," +
         "and the same size as the public exponent")
